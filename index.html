
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Agenda React - Anthony</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- React y ReactDOM desde CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel para poder escribir JSX en este mismo archivo -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
      .app { max-width:900px; margin:20px auto; background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); }
      h1 { margin-top:0; text-align:center; }
      .top-bar { text-align:center; font-size:14px; color:#555; margin-bottom:15px; }
      .layout { display:flex; gap:16px; flex-wrap:wrap; }
      .panel { flex:1 1 300px; background:#fafafa; border:1px solid #e5e7eb; border-radius:6px; padding:12px; }
      label { display:block; font-size:14px; margin-bottom:4px; }
      input { width:100%; padding:8px; margin-bottom:10px; border:1px solid #d1d5db; border-radius:4px; }
      button { background:#2563eb; color:#fff; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; }
      button:disabled { background:#9ca3af; cursor:not-allowed; }
      ul { list-style:none; padding:0; margin:0; }
      .contact-item { border-bottom:1px solid #e5e7eb; padding:6px 0; }
      .contact-item:last-child { border-bottom:none; }
      .name { font-weight:bold; }
      .error { background:#fee2e2; color:#991b1b; padding:6px 10px; border-radius:6px; margin-bottom:10px; font-size:14px; }
      .success { background:#ecfdf3; color:#166534; padding:6px 10px; border-radius:6px; margin-bottom:10px; font-size:14px; }
      .badge { display:inline-block; margin-left:8px; padding:2px 8px; font-size:12px; border-radius:999px; background:#fde68a; color:#92400e; vertical-align:middle; }
      @media (max-width:600px) { .layout { flex-direction:column; } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Endpoints
      const HTTP_API  = "http://www.raydelto.org/agenda.php";
      const HTTPS_API = "https://www.raydelto.org/agenda.php"; // por si el servidor ofrece SSL
      const PREFERRED_API = (location.protocol === "https:") ? HTTPS_API : HTTP_API;

      // Helpers para modo DEMO (localStorage)
      const DEMO_KEY = "agenda_demo_contacts_v1";
      const demoRead = () => JSON.parse(localStorage.getItem(DEMO_KEY) || "[]");
      const demoWrite = (arr) => localStorage.setItem(DEMO_KEY, JSON.stringify(arr));
      const ensureDemoSeed = () => {
        if (demoRead().length === 0) {
          demoWrite([{ nombre:"Demo", apellido:"Ejemplo", telefono:"809-000-0000" }]);
        }
      };

      function ContactList({ contactos, cargando }) {
        return (
          <div>
            <h2>Contactos guardados</h2>
            {cargando ? (
              <p>Cargando contactos...</p>
            ) : contactos.length === 0 ? (
              <p>No hay contactos.</p>
            ) : (
              <ul>
                {contactos.map((c, idx) => (
                  <li key={idx} className="contact-item">
                    <div className="name">{c.nombre} {c.apellido}</div>
                    <div>ðŸ“ž {c.telefono}</div>
                  </li>
                ))}
              </ul>
            )}
          </div>
        );
      }

      function ContactForm({ onAdd, enviando }) {
        const [nombre, setNombre] = React.useState("");
        const [apellido, setApellido] = React.useState("");
        const [telefono, setTelefono] = React.useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!nombre.trim() || !apellido.trim() || !telefono.trim()) {
            alert("Completa todos los campos");
            return;
          }
          onAdd({ nombre, apellido, telefono });
          setNombre(""); setApellido(""); setTelefono("");
        };

        return (
          <div>
            <h2>Agregar nuevo contacto</h2>
            <form onSubmit={handleSubmit}>
              <label>Nombre</label>
              <input value={nombre} onChange={(e)=>setNombre(e.target.value)} placeholder="Ej. Anthony" />
              <label>Apellido</label>
              <input value={apellido} onChange={(e)=>setApellido(e.target.value)} placeholder="Ej. Medina" />
              <label>TelÃ©fono</label>
              <input value={telefono} onChange={(e)=>setTelefono(e.target.value)} placeholder="Ej. 809-000-0000" />
              <button type="submit" disabled={enviando}>{enviando ? "Guardando..." : "Guardar contacto"}</button>
            </form>
          </div>
        );
      }

      function App() {
        const [contactos, setContactos] = React.useState([]);
        const [cargando, setCargando] = React.useState(false);
        const [enviando, setEnviando] = React.useState(false);
        const [mensaje, setMensaje] = React.useState("");
        const [error, setError] = React.useState("");
        const [modoDemo, setModoDemo] = React.useState(false);
        const [apiUsada, setApiUsada] = React.useState(PREFERRED_API);

        React.useEffect(() => {
          obtenerContactos();
        }, []);

        const obtenerContactos = async () => {
          setCargando(true); setError(""); setMensaje("");
          // 1) Intentar servidor
          try {
            const res = await fetch(PREFERRED_API);
            // Si el servidor HTTP es inaccesible desde HTTPS, esto lanza error y saltamos al catch
            const data = await res.json();
            setContactos(data);
            setModoDemo(false);
            setApiUsada(PREFERRED_API);
          } catch (err) {
            // 2) Fallback DEMO
            ensureDemoSeed();
            setContactos(demoRead());
            setModoDemo(true);
            setApiUsada("DEMO (localStorage)");
            setError("Trabajando en modo DEMO por bloqueo HTTPSâ†’HTTP (contenido mixto).");
          } finally {
            setCargando(false);
          }
        };

        const agregarContacto = async (contacto) => {
          setEnviando(true); setError(""); setMensaje("");
          if (modoDemo) {
            // Guardar local en DEMO
            const arr = demoRead(); arr.push(contacto); demoWrite(arr);
            setContactos(arr);
            setMensaje("Guardado en modo DEMO (local).");
            setEnviando(false);
            return;
          }
          try {
            await fetch(PREFERRED_API, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(contacto),
            });
            await obtenerContactos();
            setMensaje("Contacto guardado en el servidor.");
          } catch (err) {
            // Si falla en servidor, seguimos en DEMO para no romper el flujo
            const arr = demoRead(); arr.push(contacto); demoWrite(arr);
            setContactos(arr);
            setModoDemo(true);
            setApiUsada("DEMO (localStorage)");
            setMensaje("Servidor bloqueado; usando modo DEMO. El flujo funciona.");
            setError("Bloqueo por HTTPS/HTTP (contenido mixto).");
          } finally {
            setEnviando(false);
          }
        };

        return (
          <div className="app">
            <h1>
              Agenda React (Tarea 4)
              {modoDemo && <span className="badge" title="El servidor fue bloqueado por contenido mixto">DEMO</span>}
            </h1>
            <div className="top-bar">
              Endpoint: {apiUsada}<br/>
              Alumno: Anthony Medina PÃ©rez
            </div>

            {error && <div className="error">{error}</div>}
            {mensaje && <div className="success">{mensaje}</div>}

            <div className="layout">
              <div className="panel">
                <ContactForm onAdd={agregarContacto} enviando={enviando} />
              </div>
              <div className="panel">
                <ContactList contactos={contactos} cargando={cargando} />
                <button style={{ marginTop: 10 }} onClick={obtenerContactos}>Recargar lista</button>
              </div>
            </div>

            <p style={{ fontSize:12, marginTop:15, color:"#555" }}>
              Nota: En GitHub Pages (HTTPS) los navegadores bloquean peticiones a servicios HTTP. Por eso esta app cambia
              automÃ¡ticamente a <b>modo DEMO</b> para demostrar el flujo completo (listar y agregar) con <code>localStorage</code>.
              Abriendo este archivo de forma local o en HTTP utilizarÃ¡ el servidor real.
            </p>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
